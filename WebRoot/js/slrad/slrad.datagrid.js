SLRAD.prototype.setDataGrid=function(a){this.dataGrid=a};
function slradDataGrid(a){var b=this,e=new SLRAD;e.setDataGrid(b);a.data("slrad",e);this.element=a;this.id=a.attr("id");this.actionUrl=a.attr("actionUrl");this.datasource=a.attr("datasource");(this.datasourceArgs=a.attr("datasourceArgs"))&&this.element.data("datasourceArgs",SL.parseJson(this.datasourceArgs));this.dataBody=$("#"+a.attr("dataBodyId"),a);this.dataHeader=$("#"+a.attr("dataHeaderId"),a);this.navigator=$("#"+a.attr("navigatorId"),a);this.clickAction=$("#"+a.attr("clickAction"));this.dblClickAction=
$("#"+a.attr("dblClickAction"));this.dataProps={pageSize:a.attr("pageSize"),pageNum:a.attr("pageNum")};this.filterSettings={};this.navigator&&($.each({pageFirst:function(){b.pageFirst()},pageUp:function(){b.pageUp()},pageDown:function(){b.pageDown()},pageLast:function(){b.pageLast()},pageRefresh:function(){b.pageRefresh()},dataFilter:function(){b.dataFilter()},clearFilter:function(){b.clearFilter()}},function(a,d){$(":button[name='"+a+"']",b.navigator).bind("click",function(){d.call(b)})}),$("input[name='pageNum']",
b.navigator).change(function(){try{b.dataProps.pageNum=window.parseInt($(this).val())}catch(a){$(this).val(b.dataProps.pageNum)}}),$("input[name='pageSize']",b.navigator).change(function(){try{b.dataProps.pageSize=window.parseInt($(this).val())}catch(a){$(this).val(b.dataProps.pageSize)}}));if(this.dataHeader)$(b.dataHeader).on("change",":checkbox[name='selectAll']",function(){b.selectAll()});var d={fields:[],keys:[]};$("td",this.dataHeader).each(function(a){d.fields[a]={field:$(this).attr("field"),
type:$(this).attr("type"),key:$(this).attr("key"),name:$(this).text(),index:a,filter:$(this).attr("filter"),alias:$(this).attr("alias"),mapping:$(this).attr("mapping"),maxchars:$(this).attr("maxchars"),fieldClass:$(this).attr("fieldClass"),style:$(this).attr("style"),width:$(this).attr("width")};d.fields[a].key&&d.keys.push(d.fields[a])});this.dataStruct=d}
slradDataGrid.prototype.getStateParams=function(){var a=this,b={},e={},d={},c=[];$("input:checked",a.dataBody).each(function(){var b=$("tr:eq("+$(this).val()+")",a.dataBody);b.length>0&&c.push(b)});if($(":checkbox",a.dataBody).length<1){var f=$("tr.tr-selected",a.dataBody);f.length>0&&c.push(f)}$(c).each(function(){var b=$(this);$.each(a.dataStruct.fields,function(a,d){e[d.field]||(e[d.field]=[]);var c=$("td:eq("+d.index+")",b);e[d.field].push(c.attr("src_value"))});$.each(a.dataStruct.keys,function(a,
c){d[c.field]||(d[c.field]=[]);var e=$("td:eq("+c.index+")",b);d[c.field].push(e.attr("src_value"))})});b.datas=e;b.keys=d;(f=a.filterSettings.where)&&(b[SL.KEYS.FILTER_WHERE]=f);f={};f.pickedItemNum=c.length;f.where_desc=a.filterSettings.where_desc;f.totalRows=a.dataProps.totalRows;b.props=f;b.dataCallbacks={"p-1":function(){a.pageUp()},"p+1":function(){a.pageDown()},p1:function(){a.pageFirst()},pn:function(){a.pageLast()},pc:function(){a.clearFilter()},p0:$.noop,pundefined:function(){a.pageRefresh()}};
return b};slradDataGrid.prototype.pageFirst=function(){this.dataProps.pageNum=1;this.initData()};slradDataGrid.prototype.pageDown=function(){var a=this.dataProps.pageNum;a+=1;if(a>this.dataProps.totalPage)a=this.dataProps.totalPage;this.dataProps.pageNum=a;this.initData()};slradDataGrid.prototype.pageUp=function(){var a=this.dataProps.pageNum;a-=1;a<1&&(a=1);this.dataProps.pageNum=a;this.initData()};slradDataGrid.prototype.pageLast=function(){this.dataProps.pageNum=this.dataProps.totalPage+1;this.initData()};
slradDataGrid.prototype.pageRefresh=function(){this.initData()};slradDataGrid.prototype.selectAll=function(){var a=$(":checkbox[name='selectAll']",this.dataHeader).prop("checked");$(":checkbox",this.dataBody).prop("checked",a)};slradDataGrid.prototype.clearFilter=function(){this.filterSettings={};this.pageFirst()};
slradDataGrid.prototype.dataFilter=function(){var a=this,b=a.filterSettings;b.dataStruct=a.dataStruct;var e=SL.getColorboxTopWindow();e.date_filter_params=b;var b=SL.getRootPath()+"/slrad_filter.html",d=$("[dataGridId='"+a.id+"']").attr("windowStyle"),c=$("[dataGridId='"+a.id+"']").attr("windowOpacity");SL.openWindow("\u6570\u636e\u7b5b\u9009","700px","350px",d,c,b,$.noop,function(){a.filterSettings=e.data_filter_settings;e.data_filter_settings=void 0;a.pageFirst()})};
slradDataGrid.prototype.initData=function(){var a=this;a.element.trigger("beforeInitData");var b={};b[SL.KEYS.SERVICE]=a.datasource;b[SL.KEYS.PAGE_SIZE]=a.dataProps.pageSize;b[SL.KEYS.PAGE_NUM]=a.dataProps.pageNum;b[SL.KEYS.FILTER_WHERE]=a.filterSettings.where_alias;if(a.datasourceArgs){var e=a.element.data("datasourceArgs");$.extend(b,e);if(e.origin_args)b.origin_args=void 0,$.extend(b,a.element.data("cascadeArgs"));jQuery.ajaxSettings.traditional=!0}$.post(a.actionUrl,b,function(b){if(b.success==
!1)SL.error(b.message||"DataGrid\u52a0\u8f7d\u5931\u8d25\uff01",b.props&&b.props.loginUrl);else{var c=$(b.dataTable);$(":checkbox",c).click(function(a){a.stopPropagation();c.removeClass("tr-selected");$(this).parents("tr:first").addClass("tr-selected")}).dblclick(function(a){a.stopPropagation();c.removeClass("tr-selected");$(this).parents("tr:first").addClass("tr-selected")});c.click(function(){$("td:first :checkbox",$(this)).prop("checked",!0);c.removeClass("tr-selected");$(this).addClass("tr-selected")});
a.clickAction.length>0&&c.click(function(){$(":checkbox",c).not($(":checkbox",$(this))).prop("checked",!1);c.removeClass("tr-selected");$(this).addClass("tr-selected");a.clickAction.click()});a.dblClickAction.length>0&&c.dblclick(function(){$(":checkbox",c).not($(":checkbox",$(this))).prop("checked",!1);c.removeClass("tr-selected");$(this).addClass("tr-selected");a.dblClickAction.click()});a.dataBody.attr("width",a.dataHeader.attr("width"));var e=c.first().find("td").length;$("td",c).each(function(b){var c=
Math.floor(b/e),b=Math.floor(b%e),d=a.dataStruct.fields[b];if(d){var g=$(this);d.style&&g.attr("style",d.style);d.width&&g.attr("width",d.width);var h=g.text();g.attr("src_value",h);if(h&&d.mapping){var i=d.mapping.split(",");$.each(i,function(a,b){b.indexOf(h+":")==0&&g.text(b.substring(h.length+1))})}h&&d.maxchars&&(i=parseInt(d.maxchars),h.length>i&&(g.attr("title",h),g.text(h.substring(0,i)+" ...")));d.fieldClass&&g.addClass(d.fieldClass);a.element.trigger("data_td_render",[g,c,b])}});a.dataHeader.html(a.dataHeader.html());
a.dataBody.html(c);if(b.props)a.dataProps=b.props,$.each(["pageSize","pageNum","totalPage","totalRows"],function(c,e){$("input[name='"+e+"']",a.navigator).val(b.props[e]);$("[name='"+e+"']:not(input)",a.navigator).text(b.props[e])});a.element.trigger("afterInitData",b)}},"json")};
$(document).ready(function(){$(document).data("slrad_datagrid")||($(document).data("slrad_datagrid",!0),$('<style type="text/css">.tr-selected{background-color: #FFFFE0;}</style>').prependTo("head"),$("div.DataGrid").each(function(){var a=$(this),b=new slradDataGrid(a);$("[cascadeTo='"+a.attr("id")+"']").length>0?a.bind("cascadeInited",function(){b.filterSettings={};b.initData()}):b.initData()}),$(document).trigger("slrad_datagrid_ready"))});
